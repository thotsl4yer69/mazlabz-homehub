worker_processes 1;
events { worker_connections 1024; }
http {
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  upstream stepdaddy_upstream { server stepdaddylive:8000; }
  upstream hass_upstream      { server homeassistant:8123; }
  upstream homer_upstream     { server homer:8080; }
  upstream habridge_upstream  { server habridge:8080; }

  server {
    listen 8080;

    # health for sanity
    location /healthz { return 200 "ok\n"; }

    # HUB AT ROOT -> Homer dashboard
    location / {
      proxy_pass http://homer_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # StepDaddy lives here now
    location /sports/ {
      proxy_pass http://stepdaddy_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Other services
    location /hass/     { proxy_pass http://hass_upstream/; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; proxy_set_header X-Forwarded-Proto $scheme; }
    location /habridge/ { proxy_pass http://habridge_upstream/; }
    location /home/     { return 301 /; }  # old path -> root
  }
}
